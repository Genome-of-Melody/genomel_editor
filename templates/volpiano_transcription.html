{% load static %}

<link rel="stylesheet" href="{% static 'volpiano_transcription.css' %}">

<div id="volpiano_transcription">
    <div id="volpiano_transcription_result">
        {# Here be the result of the transcription. The purpose of this field #}
        {# is to provide feedback: how does the current transcription look like? #}
        {# This will likely involve quite a bit of JavaScript. #}
    </div>
    <div id="volpiano_transcription_input">
{#        Here be the input field where the user edits the volpiano string.#}
        {# The important part is the form, which triggers updates to the Melody #}
        {# object in the database. #}
        <form action="{% url 'GenomelEditor:save_annotation' %}" method="post">

            {% csrf_token %}

            <label for="volpiano_transcription_volpiano_input">Volpiano</label>
            <input id="volpiano_transcription_volpiano_input"
                   type="text"
                   name="volpiano"
                   size="{{ melody.volpiano|length|add:"120" }}"
                   value="{{ melody.volpiano }}">
            <br>
            <label for="volpiano_transcription_syllabized_text_input">Syllabized text</label>
            <input id="volpiano_transcription_syllabized_text_input"
                   type="text"
                   name="syllabized_text"
                   size="{{ melody.syllabized_text|length|add:"40" }}"
                   value="{{ melody.syllabized_text }}">
            <br>
            <button id="volpiano_transcription_do_render"
                    type="button">
                {# Without setting the type, a button in a form always submits. #}
                Render
            </button>
            <br>

            {# Here we render the current state of the transcription. #}
            {# This requires quite a bit of javascripting (below). #}
            <div id="volpiano_transcription_rendering_container">
            </div>

            <br>
            <label for="volpiano_transcription_is_adiastematic">Is adiastematic?</label>
            <input id="volpiano_transcription_is_adiastematic"
                   type="checkbox"
                   name="is_adiastematic"
                   value="{{ melody.is_adiastematic }}">
            <br>
            <label for="volpiano_transcription_is_incomplete_in_source">Is incomplete in source?</label>
            <input id="volpiano_transcription_is_incomplete_in_source"
                   type="checkbox"
                   name="is_incomplete_in_source"
                   value="{{ melody.is_incomplete_in_source }}">
            <br><br>

            <!-- State management. -->
            {% if melody.is_in_transcription %}
                <label for="volpiano_transcription_is_transcribed">Is transcribed?</label>
                <input id="volpiano_transcription_is_transcribed"
                       type="checkbox"
                       name="is_transcribed"
                       value=true
                       {% if melody.show_as_transcribed %} checked {% endif %}
                >
            {% else %}
                <!-- TODO: see if user has permission to check?
                     At this point, the user should always have the permission to check,
                     because a melody that is already transcribed and requires checking
                     should never be selected for a user who does *not* have checking permissions.-->
                <label for="volpiano_transcription_is_checked">Can be finalized?</label>
                <input id="volpiano_transcription_is_checked"
                       type="checkbox"
                       name="is_checked"
                       value=true
                       {% if melody.show_as_checked %} checked {% endif %}
                >
            {% endif %}

            <input type="hidden" value="{{ chant.id }}" name="chant_id">
            <input type="hidden" value="{{ melody.id|default_if_none:"" }}" name="melody_id">
{#          <input type="hidden" value="{{ melody.timestamp }}" name="melody_timestamp">#}

            <input type="submit" value="Save">
        </form>
    </div>
</div>

<script type="text/javascript" src="{% static "scripts/volpiano_transcription_rendering.js" %}">
    // Provides the render() function that is attached to the "Render" button on clik in the following script.
</script>
<script type="text/javascript" id="volpiano_transcription_rendering_script">
    // This is for validation purposes.
    // When the user clicks the "Render" button, we want to render the current
    // state of the transcription into the div "volpiano_transcription_rendering_container".
    // We do this in the front-end by collecting the currently transcribed
    // melody and syllabized text in the form.
    const rendering_container = document.getElementById('volpiano_transcription_rendering_container');

    render_button = document.getElementById('volpiano_transcription_do_render');
    render_button.addEventListener('click', function(event) {
        const current_volpiano = document.getElementById('volpiano_transcription_volpiano_input').value;
        const current_syllabized_text = document.getElementById('volpiano_transcription_syllabized_text_input').value;
        console.log('Current volpiano: ', current_volpiano);
        console.log('Current syllabized text: ', current_syllabized_text);

        render(current_volpiano, current_syllabized_text, rendering_container);
    })

</script>